<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>LXC / LXD</title>
	<meta name="author" content="David Gayerie">
	<link href="css/article.css" rel="stylesheet" media="screen">
	<link href="css/print-article.css" rel="stylesheet" media="print">
	<link href="highlight/styles/zenburn.css" rel="stylesheet">

	<script src="highlight/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	<script src="js/toc.js"></script>
</head>
<body>
	<div id="titleBar">
		<a href="index.html" title="Retourner au sommaire"><img src="assets/go-home.png"></a>
 		<a href="https://github.com/spoonless/epsi-b3-deploiement-continu/archive/gh-pages.zip" title="Télécharger tout le cours"><img src="assets/download.png"></a>
		<script>document.write(document.title)</script> - EPSI B3 2016/2017 - <a href="mailto:david.gayerie.epsi@mailoo.org">David Gayerie</a>
		<span class="license"><a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/"><img alt="Licence Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/fr/80x15.png" /></a></span>
	</div>

	<header></header>
	<article>
		<h1><script>document.write(document.title)</script></h1>
		<section id="toc"></section>

		<p><a href="https://linuxcontainers.org/">LXC (Linux Containers)</a> est une solution de virtualisation basée sur la capacité du noyau Linux à faire fonctionner des environnements isolés.
		Les conteneurs partagent le même noyau mais l'utilisation des processeurs, mémoire vive, système de fichier... est isolée les uns des autres.
		Il s'agit donc d'une méthode de virtualisation <i>légère</i> puisque la machine elle-même n'est pas virtualisée. On parle alors de conteneur plutôt que
		de machine virtuelle.</p>
		<p><a href="https://linuxcontainers.org/lxd/introduction/">LXD</a> est l'hyperviseur de LXC.</p>
		<p>LXC va nous permettre de créer rapidement des machines afin de pouvoir les configurer. Il s'agit donc d'un outil particulièrement utile à la
		fois pour le déploiement mais aussi les tests.</p>

		<aside class="warn">
			<p>LXD nécessite une version à jour de votre distribution Linux. Il se peut que vous ne puissiez pas installer LXD ou qu'il ne fonctionne pas correctement.
			Dans ce cas, vous devez utiliser LXC sans le support du superviseur LXD. Reportez-vous au <a href="lxc.html">chapitre décrivant l'utilisation de LXC seul</a>.</p>
		</aside>

		<section id="id1">
			<h2>Installation</h2>
			<p>L'installation de LXD se fait à partir du gestionnaire de paquet de votre distribution Linux.
			Pour une distribution basée sur Debian (Ubuntu, Mint...), il suffit de taper en ligne de commande:</p>
			<pre><code class="bash">
sudo apt install lxd
			</code></pre>
			<p>Vous devez ensuite configurer le service LXD avec la commande&nbsp;:</p>
			<pre><code class="bash">
sudo lxd init
			</code></pre>
			<p>Vous pouvez conserver la valeur des paramètres telle qu'elle vous est proposée.
			LXD est maintenant installé en tant que service. Vous allez pouvoir utiliser la commande <code>lxc</code>
			qui va vous permettre d'interagir avec l'hyperviseur.</p>
			<aside>
				<p>Par défaut, la commande <code>lxc</code> exige les droits de superutilisateur pour communiquer avec LXD.
				Pour éviter de préfixer toutes vos commandes par <code>sudo</code>, il vous suffit d'ajouter votre compte
				utilisateur au groupe <strong>lxd</strong> avec la commande suivante&nbsp;:</p>
				<pre><code class="bash">
sudo usermod -a -G lxd <span class="name variable">$USER</span>
				</code></pre>
				<p>À la prochaine connexion à votre session utilisateur, votre compte appartiendra au groupe <strong>lxd</strong>
				et vous n'aurez plus besoin des droits superutilisateur pour exécuter la commande <code>lxc</code>.</p>
			</aside>
		</section>

		<section id="utilisation">
			<h2>Utilisation</h2>
			<p><code>lxc</code> permet de manipuler facilement vos conteneurs. Cette section liste les commandes les plus utiles.</p>
			<p>Pour voir la liste des conteneurs installés, leur état et leurs adresses réseau&nbsp;:</p>
			<pre><code class="bash">
lxc list
			</code></pre>
			<p>Pour créer un conteneur ;</p>
			<pre><code class="bash">
lxc launch images:&lt;distribution&gt;/&lt;release&gt;/&lt;architecture&gt; &lt;nom du conteneur&gt;
			</code></pre>
			<p>La liste des images est disponible sur <a href="https://images.linuxcontainers.org/">https://images.linuxcontainers.org/</a>.</p>
			<p>Pour créer un conteneur Debian jessie pour une architecture 64 bits&nbsp;:</p>
			<pre><code class="bash">
lxc launch images:debian/jessie/amd64 &lt;nom du conteneur&gt;
			</code></pre>
			<p>Pour démarrer/arrêter/relancer un conteneur&nbsp;:</p>
			<pre><code class="bash">
lxc start &lt;nom du conteneur&gt;
lxc stop &lt;nom du conteneur&gt;
lxc restart &lt;nom du conteneur&gt;
			</code></pre>
			<p>Pour obtenir des informations détaillées sur le conteneur&nbsp;:</p>
			<pre><code class="bash">
lxc info &lt;nom du conteneur&gt;
			</code></pre>
			<p>Pour lancer un shell en mode superutilisateur</p>
			<pre><code class="bash">
lxc shell &lt;nom du conteneur&gt;
			</code></pre>
			<aside class="tip">
				<p>Il est possible que la commande <code>lxc shell</code> n'existe pas dans votre version de LXC. Dans ce cas, utilisez la commande&nbsp;:</p>
				<pre><code class="bash">
lxc exec &lt;nom du conteneur&gt; -- /bin/bash
				</code></pre>
			</aside>
			<p>Pour exécuter une commande en mode superutilisateur</p>
			<pre><code class="bash">
lxc exec &lt;nom du conteneur&gt; -- &lt;commande&gt;
			</code></pre>
			<p>Pour supprimer un conteneur</p>
			<pre><code class="bash">
lxc delete &lt;nom du conteneur&gt;
			</code></pre>
			<p>Pour créer un snapshot de l'état d'un conteneur</p>
			<pre><code class="bash">
lxc snapshot &lt;nom du conteneur&gt; &lt;nom du snapshot&gt;
			</code></pre>
			<p>Pour restaurer un snapshot</p>
			<pre><code class="bash">
lxc restore &lt;nom du conteneur&gt; &lt;nom du snapshot&gt;
			</code></pre>
			<p>Pour copier un conteneur</p>
			<pre><code class="bash">
lxc copy &lt;nom du conteneur&gt; &lt;nom du nouveau conteneur&gt;
			</code></pre>
			<p>Pour copier un conteneur à partir d'un snapshot</p>
			<pre><code class="bash">
lxc copy &lt;nom du conteneur&gt;/&lt;nom du snapshot&gt; &lt;nom du nouveau conteneur&gt;
			</code></pre>
		</section>
	</article>

	<article class="exercice" id="exercice">
		<h2>Exercice&nbsp;: création d'un conteneur Ubuntu</h2>
		<dl>
			<dt>Objectif</dt>
			<dd>Écrire un script shell qui permet de créer un conteneur Ubuntu Xenial.</dd>
		</dl>

		<p>Ce script permet de créer un conteneur Debian à jour avec un compte utilisateur accessible en ssh.</p>
		<pre><code class="bash">
lxc launch images:ubuntu/xenial/amd64 &lt;nom du conteneur&gt;
lxc exec &lt;nom du conteneur&gt; -- apt update
lxc exec &lt;nom du conteneur&gt; -- apt -y upgrade
lxc exec &lt;nom du conteneur&gt; -- apt -y install openssh-server
lxc exec &lt;nom du conteneur&gt; -- adduser <span class="name variable">$USER</span>
		</code></pre>
		<aside class="tip">
			<p>Le temps de création d'un conteneur peut être assez long notamment à cause des mises à jour nécessaires
			du système. Une astuce consiste à créer un image maître du système dont on fera une copie pour chaque
			nouvelle machine. En effet, copier un conteneur ne prend que quelques secondes.</p>
		</aside>
		
		<figure>
			<figcaption>Exemple de script pour LXC</figcaption>
			<pre><code class="bash">
#!/bin/bash -e

CONTAINER_NAME="$1"

while [ -z "$CONTAINER_NAME" ]
do
  read -p "Donnez le nom du nouveau conteneur: " CONTAINER_NAME
done

if [ $(lxc list -c n | grep -c "| *$CONTAINER_NAME *|") == 1 ]
then
  echo "Un conteneur porte déja ce nom..."
else
  lxc launch images:ubuntu/xenial/amd64 "$CONTAINER_NAME"
  sleep 5
fi

lxc exec "$CONTAINER_NAME" -- apt update
sleep 5
lxc exec "$CONTAINER_NAME" -- apt -y upgrade
lxc exec "$CONTAINER_NAME" -- apt -y install openssh-server python sudo
lxc exec "$CONTAINER_NAME" -- adduser $USER
lxc exec "$CONTAINER_NAME" -- usermod -a -G sudo $USER

			</code></pre>
		</figure>
	</article>

	<footer class="license">
		<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/"><img alt="Licence Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/fr/88x31.png" /></a><br />Cette œuvre est mise à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/fr/">Licence Creative Commons Attribution -  Partage dans les Mêmes Conditions 3.0 France</a>.
	</footer>
</body>
</html>
